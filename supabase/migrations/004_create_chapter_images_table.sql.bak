-- Create table to store chapter images
CREATE TABLE chapter_images (
  id SERIAL PRIMARY KEY,
  chapter_id INTEGER NOT NULL,
  image_url TEXT NOT NULL,
  image_path TEXT NOT NULL,
  user_id TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for better performance
CREATE INDEX idx_chapter_images_chapter_id ON chapter_images(chapter_id);
CREATE INDEX idx_chapter_images_user_id ON chapter_images(user_id);

-- Create RLS policies
ALTER TABLE chapter_images ENABLE ROW LEVEL SECURITY;

-- Policy to allow authenticated users to insert their own images
CREATE POLICY "Users can insert their own chapter images" ON chapter_images
FOR INSERT WITH CHECK (auth.uid()::text = user_id);

-- Policy to allow authenticated users to view their own images
CREATE POLICY "Users can view their own chapter images" ON chapter_images
FOR SELECT USING (auth.uid()::text = user_id);

-- Policy to allow authenticated users to update their own images
CREATE POLICY "Users can update their own chapter images" ON chapter_images
FOR UPDATE USING (auth.uid()::text = user_id);

-- Policy to allow authenticated users to delete their own images
CREATE POLICY "Users can delete their own chapter images" ON chapter_images
FOR DELETE USING (auth.uid()::text = user_id);